# Данные для финального теста (60 вопросов)
FINAL_TEST = {
    "name": "Итоговый тест по всем модулям",
    "time_limit_minutes": 60,
    "questions": [
        {
            "question": "1. Какой модуль в OPERA PMS отвечает за управление номерами?",
            "options": ["a) RMS", "b) S&C", "c) ORS", "d) OXI"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "2. Что означает статус номера 'Out of Order' (OOO)?",
            "options": ["a) Номер не требует уборки", "b) Номер грязный", "c) Номер не пригоден для продажи (с обслуживанием)", "d) Номер готов для заселения"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "3. Какой статус номера означает, что он убран и готов для заселения нового гостя?",
            "options": ["a) Dirty (Грязный)", "b) Out of Order (С обслуживанием)", "c) Clean (Чистый)", "d) Ready (Подготовлен)"],
            "correct_answers": ["d"],
            "type": "single"
        },
        {
            "question": "4. Какой вид тарифа (Rate Plan) предназначен для корпоративных клиентов?",
            "options": ["a) RACK", "b) CORP", "c) PROMO", "d) GROUP"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "5. Какой документ является основанием для внесения счета в 1С на оплату гостиничных услуг?",
            "options": ["a) Акт выполненных работ", "b) Счет-фактура", "c) Счет на оплату", "d) Договор"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "6. Что такое кредитная линия (credit limit) для корпоративного клиента?",
            "options": ["a) Максимальная сумма скидки", "b) Максимальная сумма задолженности, разрешенная для отсрочки платежа", "c) Лимит на количество бронирований", "d) Минимальная сумма гарантии"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "7. Что позволяет делать сервис Paylink?",
            "options": ["a) Автоматически отправлять отчеты", "b) Принимать онлайн-платежи по ссылке", "c) Синхронизировать календари", "d) Управлять статусами номеров"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "8. Что включает в себя отправка платежной ссылки?",
            "options": ["a) Отправку госту ссылки на согласие с правилами отеля", "b) Отправку клиенту ссылки для онлайн-оплаты счета", "c) Отправку в бухгалтерию ссылки на документ", "d) Отправку ссылки для регистрации в лояльности"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "9. Для чего требуется доступ к 1С и оформление подписи?",
            "options": ["a) Для просмотра финансовых отчетов", "b) Для подписания и отправки юридически значимых счетов и актов", "c) Для настройки тарифов", "d) Для учета рабочего времени"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "10. Как правильно настроить общий почтовый ящик отдела бронирования в Outlook?",
            "options": ["a) Создать новую учетную запись на каждого сотрудника", "b) Добавить общий ящик как дополнительный в своем Outlook", "c) Использовать один пароль для всех", "d) Не настраивать, работать через веб-интерфейс"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "11. Как отправить письмо от имени отдела бронирования (с адреса отдела), а не от своего имени?",
            "options": ["a) Указать адрес отдела в тексте письма", "b) Использовать опцию 'Отправить от имени' (Send From)", "c) Сначала отправить себе, потом переслать", "d) Это невозможно сделать"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "12. Какой инструмент Outlook помогает автоматически сортировать входящие письма по папкам?",
            "options": ["a) Категории", "b) Шаблоны", "c) Правила", "d) Быстрые действия"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "13. Что такое шаблоны писем (Templates) и для чего они используются?",
            "options": ["a) Для создания новых почтовых ящиков", "b) Для быстрой отправки стандартизированных ответов", "c) Для шифрования писем", "d) Для отслеживания прочтения"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "14. Какой элемент телефонного этикета является обязательным в начале звонка?",
            "options": ["a) Спросить 'Чем могу помочь?'", "b) Представиться и назвать отель/отдел", "c) Немедленно перевести на нужного сотрудника", "d) Уточнить полное имя клиента"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "15. Как правильно обработать входящий звонок с запросом на бронирование?",
            "options": ["a) Немедленно назвать цены", "b) Уточнить даты, тип номера, количество гостей", "c) Попросить перезвонить позже", "d) Сразу перевести в отдел продаж"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "16. Что важно сделать при консультировании клиента по телефону?",
            "options": ["a) Использовать профессиональный сленг", "b) Говорить быстро, чтобы успеть", "c) Активно слушать и уточнять потребности", "d) Дать максимум информации без остановки"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "17. Какой шаг является ключевым при решении проблемы клиента по телефону?",
            "options": ["a) Сразу предложить компенсацию", "b) Выяснить суть проблемы и предложить решение", "c) Передать звонок руководителю", "d) Извиниться и положить трубку"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "18. Какой инструмент в OPERA PMS используется для просмотра доступности номеров?",
            "options": ["a) Availability Grid", "b) Reservation Diary", "c) Room Plan", "d) All of the above"],
            "correct_answers": ["d"],
            "type": "single"
        },
        {
            "question": "19. Как создать корпоративный тариф (CORP Rate) в OPERA?",
            "options": ["a) Только через ИТ-отдел", "b) В модуле 'Rate Management'", "c) В настройках номера", "d) В профиле гостя"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "20. Какие данные необходимы для выставления счета в 1С? (Выберите несколько)",
            "options": ["a) Реквизиты компании-плательщика", "b) Перечень оказываемых услуг и их стоимость", "c) Номер телефона менеджера", "d) Даты оказания услуг", "e) Личные данные бухгалтера"],
            "correct_answers": ["a", "b", "d"],
            "type": "multiple"
        },
        {
            "question": "21. Что произойдет, если корпоративный клиент превысит установленную кредитную линию?",
            "options": ["a) Система автоматически предоставит скидку", "b) Система может заблокировать возможность создания новых броней до погашения долга", "c) Ничего, линия увеличится автоматически", "d) Отправится уведомение в налоговую"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "22. Для отправки платежной ссылки через Paylink обычно требуется:",
            "options": ["a) Номер бронирования и email гостя", "b) Только ФИО гостя", "c) Паспортные данные гостя", "d) Реквизиты банка отеля"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "23. Как организовать входящую почту, чтобы не пропускать важные запросы? (Выберите несколько)",
            "options": ["a) Использовать правила для сортировки по темам или отправителям", "b) Создавать папки для разных типов запросов (бронирования, счета, вопросы)", "c) Отключать уведомления", "d) Использовать цветные категории для приоритета", "e) Ничего не делать, все письма должны быть во 'Входящих'"],
            "correct_answers": ["a", "b", "d"],
            "type": "multiple"
        },
        {
            "question": "24. Какую фразу следует избегать при телефонном разговоре с клиентом?",
            "options": ["a) 'Я не знаю'", "b) 'Сейчас выясню для вас'", "c) 'Подождите минуту, пожалуйста'", "d) 'Благодарю за ожидание'"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "25. Какой статус в OPERA PMS присваивается номеру после выезда гостя?",
            "options": ["a) Clean", "b) Ready", "c) Dirty", "d) Vacant"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "26. Что такое 'Stay Record' в контексте OPERA PMS?",
            "options": ["a) Запись о предстоящем заезде", "b) История всех транзакций и событий проживания гостя", "c) Отчет о загрузке отеля", "d) Шаблон для бронирования"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "27. Какой тип бронирования создается для корпоративного клиента по договору?",
            "options": ["a) Групповое (Group)", "b) Тур-агентское (Travel Agent)", "c) Корпоративное (Corporate)", "d) То же, что и для обычного гостя"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "28. Что из перечисленного является преимуществом корпоративного тарифа?",
            "options": ["a) Он всегда самый низкий", "b) Он фиксирован и не зависит от спроса", "c) Он привязан к конкретному договору и часто включает специальные условия", "d) На него не распространяются правила отмены"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "29. Что такое 'постоплата' при работе с корпоративными клиентами?",
            "options": ["a) Оплата до заезда", "b) Оплата в момент заезда", "c) Оплата после оказания услуг (по счету)", "d) Оплата бонусными баллами"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "30. Какой документ часто требуется для открытия кредитной линии?",
            "options": ["a) Публичная оферта", "b) Анкета гостя", "c) Договор с приложением о платежных условиях", "d) Визитная карточка менеджера"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "31. Что можно оплатить с помощью платежной ссылки Paylink? (Выберите несколько)",
            "options": ["a) Только проживание", "b) Проживание и дополнительные услуги (завтрак, паркинг)", "c) Гарантийный депозит", "d) Штраф за отмену", "e) Зарплату сотрудников"],
            "correct_answers": ["b", "c", "d"],
            "type": "multiple"
        },
        {
            "question": "32. Электронная подпись в 1С нужна для:",
            "options": ["a) Входа в систему", "b) Заверения электронных документов (счетов, актов)", "c) Подписки на рассылку", "d) Настройки интерфейса"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "33. Что такое 'Делегирование прав' (Permissions) в контексте общего почтового ящика Outlook?",
            "options": ["a) Право удалять письма", "b) Право отправлять письма от имени ящика и работать с его содержимым", "c) Право менять пароль", "d) Право блокировать ящик"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "34. Для чего в Outlook используют функцию 'Быстрые части' (Quick Parts)?",
            "options": ["a) Для ускорения поиска", "b) Для сохранения и быстрой вставки часто используемых фрагментов текста (подписей, приветствий)", "c) Для сортировки контактов", "d) Для создания правил"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "35. Какой прием телефонного общения помогает убедиться, что вы правильно поняли клиента?",
            "options": ["a) Переспрос и уточняющие вопросы", "b) Длительное молчание", "c) Быстрый ответ, не дослушав", "d) Использование сложных терминов"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "36. Что следует сделать перед тем, как перевести звонок другому сотруднику?",
            "options": ["a) Предупредить клиента и назвать имя и отдел того, к кому переводите", "b) Просто нажать кнопку перевода", "c) Попросить клиента перезвонить на прямой номер", "d) Положить трубку и сообщить коллеге позвонить"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "37. Какая информация ОБЯЗАТЕЛЬНО должна быть в профиле корпоративного клиента в OPERA PMS? (Выберите несколько)",
            "options": ["a) Название компании", "b) ИНН/реквизиты для счета", "c) Корпоративный тариф (CORP Rate Code)", "d) Личные хобби контактного лица", "e) Условия оплаты и кредитный лимит"],
            "correct_answers": ["a", "b", "c", "e"],
            "type": "multiple"
        },
        {
            "question": "38. В каком случае номер получает статус 'Ready' (Готов)?",
            "options": ["a) После проверки горничной", "b) После уборки и проверки супервайзером/службой приема", "c) После выезда гостя", "d) После ремонта"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "39. Где в OPERA PMS можно увидеть историю изменения тарифов на номер?",
            "options": ["a) В Rate Query", "b) В Rate Availability", "c) В Audit Trail профиля бронирования", "d) В настройках системы"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "40. Какой отчет в 1С помогает отслеживать состояние дебиторской задолженности корпоративных клиентов?",
            "options": ["a) Оборотно-сальдовая ведомость", "b) Анализ счета (карточка счета)", "c) Отчет по продажам", "d) Ведомость по зарплате"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "41. Что нужно проверить перед одобрением постоплаты по новой кредитной линии?",
            "options": ["a) Только название компании", "b) Подписанный договор, установленный в системе лимит и условия", "c) Отзывы в интернете", "d) Наличие визиток"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "42. Какая информация обычно содержится в платежной ссылке?",
            "options": ["a) Логин и пароль от Wi-Fi", "b) Сумма к оплате, назначение платежа и безопасная форма для ввода карточных данных", "c) Номер паспорта гостя", "d) Внутренние реквизиты отеля"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "43. Как обеспечить, чтобы все сотрудники отдела видели ответы на письма в общем ящике?",
            "options": ["a) Распечатывать все письма", "b) Использовать функцию 'Ответить всем', включая адрес общего ящика в копию", "c) Каждому отвечать отдельно", "d) Сохранять ответы в папку 'Отправленные' общего ящика (это происходит автоматически при отправке от его имени)"],
            "correct_answers": ["d"],
            "type": "single"
        },
        {
            "question": "44. Как эффективно работать с большим потоком писем? (Выберите несколько)",
            "options": ["a) Отмечать важные письма флажками", "b) Создавать задачи из писем", "c) Отвечать на все письма в конце дня", "d) Использовать отсрочку отправки", "e) Удалять все непрочитанные письма старше дня"],
            "correct_answers": ["a", "b", "d"],
            "type": "multiple"
        },
        {
            "question": "45. Что означает техника активного слушания при телефонном разговоре?",
            "options": ["a) Говорить больше клиента", "b) Делать устные заметки ('Понимаю', 'Хорошо'), уточнять, резюмировать услышанное", "c) Молчать, пока клиент говорит", "d) Задавать личные вопросы"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "46. Как поступить, если клиент агрессивно настроен по телефону?",
            "options": ["a) Перебить и дать отпор", "b) Сохранять спокойствие, дать высказаться, извиниться за проблему и предложить решение", "c) Немедленно положить трубку", "d) Перевести его на другого случайного сотрудника"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "47. Как в OPERA PMS найти все бронирования определенной корпоративной компании?",
            "options": ["a) Чрез поиск по имени гостя", "b) Через поиск по коду корпоративного соглашения (Company Agreement Code) или названию компании", "c) Только по номеру бронирования", "d) Просматривая все бронирования подряд"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "48. Что такое 'Non-Guaranteed' бронирование?",
            "options": ["a) Бронирование с обязательной предоплатой", "b) Бронирование без гарантии (отель может снять его после определенного часа, если не получены гарантии)", "c) Бронирование только для VIP-гостей", "d) Групповое бронирование"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "49. Какой тип корпоративного тарифа может быть привязан к конкретному сегменту номеров?",
            "options": ["a) Все корпоративные тарифы", "b) Только публичные (RACK) тарифы", "c) Тарифы, настроенные с привязкой к кодам номеров (Room Class) или типу (Room Type)", "d) Это невозможно настроить"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "50. Как часто рекомендуется сверять данные по дебиторской задолженности между OPERA PMS и 1С?",
            "options": ["a) Раз в год", "b) Ежемесячно (или в соответствии с регламентом отеля)", "c) Никогда, системы синхронизированы автоматически", "d) Только при возникновении проблем у клиента"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "51. Что такое 'договорной счет' в 1С?",
            "options": ["a) Счет на оплату, сформированный на основании договора с клиентом", "b) Счет на оплату коммунальных услуг", "c) Внутренний счет для учета", "d) Счет-фактура для НДС"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "52. Как можно безопасно отправить клиенту платежную ссылку на крупную сумму?",
            "options": ["a) Сообщить по SMS", "b) Отправить на корпоративный email, указанный в договоре, с пояснительным письмом", "c) Продиктовать по телефону", "d) Выложить в общий доступ на сайте"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "53. Как создать новое правило (Rule) для сортировки писем в Outlook?",
            "options": ["a) Правой кнопкой по письму -> Создать правило", "b) Через меню Файл -> Параметры", "c) Через вкладку 'Вид'", "d) Только в веб-версии"],
            "correct_answers": ["a"],
            "type": "single"
        },
        {
            "question": "54. Что такое 'Совместный доступ к календарю' общего почтового ящика и зачем он нужен?",
            "options": ["a) Чтобы видеть личные встречи друг друга", "b) Чтобы отслеживать сроки ответов на письма", "c) Чтобы видеть запланированные задачи/встречи отдела (например, график дежурств, deadlines по отчетам)", "d) Он не нужен"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "55. Как правильно завершить телефонный разговор с клиентом?",
            "options": ["a) 'Пока!'", "b) Резко положить трубку после решения вопроса", "c) Поблагодарить за звонок, назвать свое имя еще раз (при необходимости) и вежливо попрощаться", "d) Попросить клиента больше не звонить"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "56. Что делать, если вы не знаете ответ на вопрос клиента по телефону?",
            "options": ["a) Сказать 'Не знаю' и положить трубку", "b) Дать случайный, возможно неверный, ответ", "c) Извиниться, честно сказать, что уточните информацию, и договориться о времени обратного звонка", "d) Сделать вид, что связь прервалась"],
            "correct_answers": ["c"],
            "type": "single"
        },
        {
            "question": "57. Как в OPERA PMS проверить, действует ли корпоративный тариф на нужные даты?",
            "options": ["a) Открыть профиль компании", "b) Сделать запрос на бронирование (New Reservation) и ввести даты, код компании и код тарифа", "c) Посмотреть в настройках системы", "d) Спросить у руководителя"],
            "correct_answers": ["b"],
            "type": "single"
        },
        {
            "question": "58. Что должно быть согласовано с корпоративным клиентом ДО начала пользования услугами по постоплате? (Выберите несколько)",
            "options": ["a) Кредитный лимит", "b) Сроки оплаты счетов (например, 10 дней с даты выставления)", "c) Лицо, уполномоченное подтверждать счета", "d) Порядок предоставления отчетных документов (акты, счета-фактуры)", "e) Любимый номер менеджера"],
            "correct_answers": ["a", "b", "c", "d"],
            "type": "multiple"
        },

        {
            "question": "59. Какой статус номера означает, что он убран и готов для заселения нового гостя?",
            "options": [
                "a) Dirty (Грязный)",
                "b) Out of Order (С обслуживанием)",
                "c) Clean (Чистый)",
                "d) Ready (Подготовлен)"
            ],
            "correct_answers": ["d"],
            "type": "single"
        },
        {
            "question": "60. Какую кнопку нужно нажать в Outlook, чтобы отправить письмо от имени всего отдела бронирования?",
            "options": [
                "a) Ответить",
                "b) Показать поле «Кому»",
                "c) Показать поле «От»",
                "d) Важное"
            ],
            "correct_answers": ["c"],
            "type": "single"
        },
        # Добавьте еще 58 вопросов здесь
        # Вопросы 3-60...
    ]
}

# Пароль для доступа к финальному тесту
FINAL_TEST_PASSWORD = "final2024"

# Хранение сессий финального теста
final_test_sessions = {}


def start_final_test_session(user_id, fio):
    """Начать сессию финального теста"""
    final_test_sessions[user_id] = {
        'fio': fio,
        'start_time': None,
        'current_question': 0,
        'answers': [],
        'timer_started': False,
        'notifications_sent': {
            30: False,
            50: False,
            55: False
        }
    }
    return final_test_sessions[user_id]


def get_final_test_session(user_id):
    """Получить сессию финального теста"""
    return final_test_sessions.get(user_id)


def update_final_test_answer(user_id, answer):
    """Обновить ответ в финальном тесте"""
    if user_id in final_test_sessions:
        final_test_sessions[user_id]['answers'].append(answer)


def next_final_question(user_id):
    """Перейти к следующему вопросу в финальном тесте"""
    if user_id in final_test_sessions:
        final_test_sessions[user_id]['current_question'] += 1


def finish_final_test_session(user_id):
    """Завершить сессию финального теста"""
    if user_id in final_test_sessions:
        return final_test_sessions.pop(user_id)
    return None


def check_final_test_password(password):
    """Проверить пароль для финального теста"""
    return password == FINAL_TEST_PASSWORD


def calculate_final_test_score(answers):
    """Рассчитать результат финального теста"""
    correct_answers = [q['correct_answers'] for q in FINAL_TEST['questions']]

    score = 0
    for i, (user_answer, correct_answer) in enumerate(zip(answers, correct_answers)):
        if i < len(answers) and set(user_answer) == set(correct_answer):
            score += 1

    percentage = (score / len(FINAL_TEST['questions'])) * 100
    return percentage, score, len(FINAL_TEST['questions'])